# DELAxPM プラットフォーム化要件定義書

## 1. プロジェクト概要

### 1.1 目的
PMLibrary（二代目）をコアシステムとして汎用番組制作管理プラットフォーム「DELAxPM」に発展させ、PMPlatto（初代）を最新版にアップデートする。

### 1.2 ゴール
- PMLibraryをベースとした汎用プラットフォームの構築
- 新番組を3クリック・3分以内でセットアップできる環境の実現
- PMPlattoの最新版へのアップデート
- 開発・運用効率の向上

## 2. 機能要件

### 2.1 PMLibraryの全機能を保持（コアシステム）
1. **番組管理**
   - 番組情報の登録・編集・削除
   - 番組詳細情報の管理

2. **エピソード管理**
   - エピソード一覧表示
   - エピソードのカンバンボード管理
   - エピソード詳細情報の編集
   - CSVインポート機能

3. **チームダッシュボード**
   - メモウィジェット
   - スケジュールウィジェット
   - タスクウィジェット
   - クイックリンクウィジェット

4. **チームイベント管理**
   - イベントの作成・編集・削除
   - カレンダー表示

5. **週次レビュー機能**
   - 自動レビュー生成
   - メール送信機能

### 2.2 プラットフォーム化機能（新規追加）
1. **マルチテナント対応**
   - 番組ごとの独立した環境
   - 権限管理の強化

2. **3クリック自動セットアップ機能**
   - ワンコマンドでの環境構築（`./setup-new-project.sh "新番組名" "pmplatform"`）
   - テンプレートベースの初期設定
   - 3分以内での完全セットアップ

3. **プラットフォーム管理画面**
   - 番組一覧管理
   - ユーザー管理
   - システム設定

### 2.3 PMPlattoアップデート要件
1. **Supabaseスキーマの更新（PMLibraryレベルに）**
   - 基本`programs`テーブル → 拡張版に更新
   - 新規テーブル追加：`episodes`, `status_history`, `episode_statuses`, `calendar_tasks`
   - 高度機能追加：トリガー、ビュー、RLS強化

2. **PMLibraryフロントエンドの適用**
   - 最新の機能とUIの適用
   - エピソード管理、チームダッシュボード機能の利用

3. **データ移行**
   - 既存PMPlattoの`programs`データを保持
   - PMLibraryスキーマに合わせてデータ構造を更新

## 3. 非機能要件

### 3.1 パフォーマンス
- ページロード時間: 3秒以内
- API応答時間: 200ms以内
- 同時接続ユーザー数: 100人以上

### 3.2 可用性
- アップタイム: 99.9%以上
- ダウンタイムなしでのデプロイ

### 3.3 セキュリティ
- Supabase Auth による認証
- Row Level Security (RLS) による権限制御
- 環境変数による機密情報管理

### 3.4 開発効率
- モノレポによるコード共有
- 共通UIコンポーネントライブラリ
- 統一されたTypeScript型定義

## 4. 技術要件

### 4.1 フロントエンド
- React 18+
- TypeScript 5+
- Vite
- Tailwind CSS
- Shadcn/ui（UIコンポーネント）

### 4.2 バックエンド
- Supabase
  - PostgreSQL
  - Auth
  - Realtime
  - Edge Functions

### 4.3 インフラ
- Netlify（ホスティング）
- GitHub Actions（CI/CD）

### 4.4 開発環境
- Turborepo または Nx（モノレポ管理）
- pnpm（パッケージマネージャー）
- ESLint & Prettier（コード品質）

## 5. 制約事項

### 5.1 既存システムとの互換性
- 既存のPMLibraryデータの完全保持（そのまま使用）
- PMPlattoの基本`programs`データをPMLibrary拡張スキーマに移行
- PMPlattoのSupabaseスキーマをPMLibraryレベルに更新
- 既存URLのリダイレクト対応
- ユーザー認証情報の引き継ぎ

### 5.2 移行期間中の要件
- Blue-Greenデプロイメントによる無停止移行
- ロールバック可能な構成
- データ同期期間の設定

## 6. 成功基準

### 6.1 技術的成功基準
- データ移行時の損失: 0件
- システム停止時間: 0分
- 全自動テストの合格率: 100%

### 6.2 ビジネス成功基準
- 新番組セットアップ: 3クリック・3分以内
- 既存ユーザーからのクレーム: 0件
- 開発効率の向上: 30%以上

## 7. リスクと対策

### 7.1 技術的リスク
- **PMPlattoのSupabaseスキーマ更新時のデータ損失**
  - 対策: 事前の完全バックアップと段階的スキーマ移行

- **スキーマ変更によるアプリケーション互換性の問題**
  - 対策: PMLibraryとの完全互換性確認とテスト

- **パフォーマンス劣化**
  - 対策: 事前の負荷テストと最適化

- **Netlify依存関係設定問題**（2025年7月31日実証）
  - 問題: NODE_ENV=productionでdevDependenciesが除外される
  - 対策: ビルド時必要パッケージ（tailwindcss, postcss, autoprefixer）をdependenciesに配置
  - 学習: 環境変数はnetlify.tomlの[build.environment]に直接設定

- **複数リポジトリ管理の混乱**（2025年7月31日実証）
  - 問題: 作業リポジトリとデプロイリポジトリの不一致
  - 対策: デプロイ先リポジトリの明確化と作業手順の文書化
  - 学習: リポジトリ管理の複雑さがモノレポ統合を困難にする主要因

- **機能移植時の設定複雑性**（2025年7月31日実証）
  - 問題: 単純な機能移植でも多数の設定調整が必要
  - 対策: 段階的ハイブリッド戦略による段階的アプローチ
  - 学習: 早期統合より運用安定性を重視した段階的改善が適切

### 7.2 運用リスク
- **ユーザー混乱**
  - 対策: 十分な事前告知と移行ガイドの提供

## 8. フェーズ分け（段階的ハイブリッド戦略に基づく）

### Phase 1: 現状維持 + 効率的機能移植（1-2ヶ月）
**基本方針**: 各チーム独立運用を維持しつつ、機能移植を効率化

#### Week 1-2: 機能移植基盤整備
- 機能移植用テンプレート・スクリプト作成
- 設定トラブル解決ナレッジの文書化
- PMLibrary→PMPlatto移植手順の標準化

#### Week 3-4: 段階的機能移植
- 優先度の高い機能から段階的移植
- 各移植での学習内容の蓄積
- 移植効率の測定・改善

#### Week 5-8: 運用実績収集
- 両チームでの独立運用継続
- 機能移植頻度・コストの実測
- 共通化候補機能の特定

### Phase 2: 選択的統合判断（2-3ヶ月後）
**判断基準**: 機能移植の頻度・コスト、各チームの運用安定性、開発効率の実測値

#### 統合検討項目
- 高頻度移植機能の共通パッケージ化
- 各アプリの独立性維持
- 実績に基づく統合効果の評価

### Phase 3: データ駆動による最適化（将来計画）
- Phase 1-2の運用実績を基にした最適戦略決定
- 必要に応じた真の統合基盤構築

---

この要件ファイルは、PM統合開発方針書を基に作成され、プロジェクトの実際の方針に合わせて修正されました。