# PMプラットフォーム統合 トラブルシューティング ナレッジベース

**作成日**: 2025年7月31日  
**最終更新**: 2025年7月31日  
**ステータス**: アクティブ（実証済み）

## 概要

PMLibraryからPMPlattoへの機能移植時に発生した実際の問題と解決策を記録したナレッジベース。将来の機能移植作業の効率化と問題回避を目的とする。

## 🚨 Critical Issues（重要な問題）

### 1. Netlify依存関係問題

**発生日**: 2025年7月31日  
**症状**: 
```
Error: Loading PostCSS Plugin failed: Cannot find module 'tailwindcss'
NODE_ENV=productionでdevDependenciesが除外される
```

**根本原因**: 
- Netlifyの本番環境では`NODE_ENV=production`が設定される
- この設定により`devDependencies`のパッケージがインストールされない
- しかし`postcss.config.js`で`tailwindcss`を要求するため、ビルド時にエラー発生

**解決策**:
```json
// package.jsonでビルド時必要なパッケージをdependenciesに移動
{
  "dependencies": {
    "tailwindcss": "^3.4.1",
    "postcss": "^8.4.35", 
    "autoprefixer": "^10.4.18"
  }
}
```

**予防策**:
- ビルド時に必要なパッケージは必ず`dependencies`に配置
- `devDependencies`は開発時のみ使용するツール（eslint, prettier等）に限定

### 2. 環境変数設定問題

**発生日**: 2025年7月31日  
**症状**:
```
Invalid API key
VITE_SUPABASE_URLやVITE_SUPABASE_ANON_KEYが認識されない
```

**根本原因**:
- ローカルの`.env`ファイルは本番環境では読み込まれない
- Netlifyでは独自の環境変数設定が必要

**解決策**:
```toml
# netlify.toml
[build.environment]
VITE_SUPABASE_URL = "https://pgropwfkdcvbccdgscff.supabase.co"
VITE_SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
```

**予防策**:
- 本番環境の環境変数は`netlify.toml`に直接設定
- センシティブな情報はNetlify UIで設定（リポジトリに含めない）

### 3. リポジトリ管理混乱

**発生日**: 2025年7月31日  
**症状**:
- 作業リポジトリと実際のデプロイリポジトリが異なる
- Netlifyは特定のリポジトリに接続されているが、作業は別のリポジトリで実施

**根本原因**:
- delax-unified-pmで作業していたが、実際のPMPlattoは別リポジトリ
- Netlifyの接続先は`https://github.com/DELAxGithub/PMplatto.git`

**解決策**:
- 作業前にデプロイリポジトリを明確に確認
- 変更は必ず正しいリポジトリにpush

**予防策**:
```markdown
# リポジトリ管理チェックリスト
1. どのリポジトリで作業するか確認
2. Netlifyの接続先リポジトリを確認
3. 作業完了後、正しいリポジトリにpush
4. デプロイが正常に開始されることを確認
```

## ⚠️ Warning Issues（注意が必要な問題）

### 4. MCPテストユーザー管理

**発生日**: 2025年7月31日  
**症状**:
- 既存のテストユーザー（user@example.com）のパスワードが不明
- 新しいテストユーザーの動的作成が必要

**解決策**:
- MCPを使用して新しいテストユーザーを作成
- アカウント情報: `test.user@pmplatto.dev` / `password123`

**予防策**:
- テストユーザーの認証情報を文書化
- 本番環境用のテストアカウント管理手順を確立

## 🔧 Best Practices（ベストプラクティス）

### 機能移植時のチェックリスト

1. **事前確認**
   - [ ] 移植先リポジトリの確認
   - [ ] Netlify接続先の確認
   - [ ] 既存環境変数の確認

2. **依存関係チェック**
   - [ ] package.jsonのdependencies/devDependencies適切性
   - [ ] ビルド時必要パッケージの特定
   - [ ] 新しい依存関係の追加確認

3. **環境設定**
   - [ ] .envファイルの作成
   - [ ] netlify.tomlの環境変数設定
   - [ ] 本番環境での動作確認

4. **テスト・検証**
   - [ ] ローカルビルドの成功確認
   - [ ] 本番デプロイの成功確認
   - [ ] 全機能の動作確認
   - [ ] テストアカウントでのログイン確認

### 問題発生時の対応手順

1. **即座の対応**
   - エラーログの詳細確認
   - 直前の変更内容の洗い出し
   - 可能であればロールバック

2. **根本原因の特定**
   - 環境差異の確認（ローカル vs 本番）
   - 設定ファイルの確認
   - 依存関係の確認

3. **解決策の実装**
   - 最小限の変更で問題解決
   - 段階的な修正とテスト
   - 変更内容の文書化

4. **再発防止**
   - 問題の根本原因分析
   - チェックリストの更新
   - 手順書の改善

## 📈 継続的改善

### 学習事項の反映

今日の作業から得られた重要な学習：

1. **モノレポ統合の複雑さ**
   - 単純に見える機能移植でも多数の設定調整が必要
   - 各アプリの独立性維持の価値が高い

2. **運用継続の重要性**
   - 開発効率より運用安定性を優先すべき
   - 段階的アプローチの重要性

3. **設定管理の複雑性**
   - 複数環境での設定の一貫性維持の困難さ
   - 環境固有の設定要件の理解が必要

### 今後の改善計画

1. **機能移植テンプレートの作成**
   - 標準的な移植手順の文書化
   - チェックリストの詳細化

2. **自動化の検討**
   - 設定チェックスクリプトの作成
   - 環境差異検出ツールの開発

3. **知識共有の促進**
   - トラブルシューティング事例の蓄積
   - チーム間での知識共有体制の構築

---

**この文書は実際に発生した問題とその解決策を記録しています。新しい問題が発生した場合は、必ずこの文書に追記してください。**